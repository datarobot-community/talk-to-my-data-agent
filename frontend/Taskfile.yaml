---
# https://taskfile.dev
version: '3'

# In Notebooks, drop PYTHONPATH to avoid dependency collisions
env:
  CALCULATED_PYTHONPATH: "{{ if and .PYTHONPATH .NOTEBOOK_ID }}{{ else }}{{ .PYTHONPATH }}{{ end }}"
  TEST_USER_EMAIL: "dev@example.com"

tasks:

  auth-check:
    silent: true
    desc: "ğŸ” Check authentication prerequisites"
    cmds:
      - |
        if command -v dr &> /dev/null && dr auth help 2>&1 | grep -q "check"; then
          echo "ğŸ” Checking authentication.."
          dr auth check
        else
          echo "â„¹ï¸  Skipping auth check (not available)"
        fi

  install:
    desc: "ğŸ”§ Install dependencies"
    cmds:
      - echo "ğŸ”§ Installing dependencies.."
      - uv sync --all-extras --dev

  dev:
    silent: true
    desc: "ğŸ”¨ Run the development server"
    deps:
      - auth-check
    env:
      DISABLE_TELEMETRY: true
      TEST_USER_EMAIL: "dev@example.com"
    cmds:
      - echo "ğŸ”¨ Starting development server"
      - PYTHONPATH="$CALCULATED_PYTHONPATH" uv run streamlit run 'app.py' --server.maxUploadSize 200

  lint:
    silent: true
    desc: "ğŸ§¹ Run linters"
    cmds:
      - echo "ğŸ§¹ Running linters.."
      - uv run ruff format .
      - uv run ruff check . --fix
      - PYTHONPATH="$CALCULATED_PYTHONPATH" uv run mypy --pretty .

  lint-check:
    silent: true
    desc: "ğŸ§¹ Check whether the codebase is linted"
    cmds:
      - uv run ruff format --check .
      - uv run ruff check .
      - PYTHONPATH="$CALCULATED_PYTHONPATH" uv run mypy --pretty .

  test:
    silent: true
    desc: "ğŸ§ª Run tests"
    cmds:
      - echo "ğŸ§ª Running tests.."
      - PYTHONPATH="$CALCULATED_PYTHONPATH" uv run pytest --cov --cov-report=html --cov-report=term --cov-report xml:.coverage.xml

  copyright:
    aliases: [license]
    desc: ğŸ“œ Apply license headers
    cmds:
      - echo "ğŸ“œ Applying license headers"
      - docker run  --rm -v $PWD:/github/workspace ghcr.io/apache/skywalking-eyes/license-eye:eb0e0b091ea41213f712f622797e37526ca1e5d6
        -v info -c .licenserc.yaml header fix

  copyright-check:
    aliases: [license-check]
    desc: ğŸ“œ Checking for license headers
    cmds:
      - echo "ğŸ“œ Checking license headers"
      - docker run  --rm -v $PWD:/github/workspace ghcr.io/apache/skywalking-eyes/license-eye:eb0e0b091ea41213f712f622797e37526ca1e5d6
        -v info -c .licenserc.yaml header check
